<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>WebRTC Broadcaster (Minimal)</title>
  <style>
    body { background: #000; margin: 0; color: white; }
    #local { position: fixed; bottom: 10px; right: 10px; width: 160px; border: 2px solid #fff; }
    #remote-container video { width: 200px; margin: 5px; background: #333; }
  </style>
</head>

<body>

<video id="local" autoplay playsinline muted></video>
<div id="remote-container"></div>

<script>
/* ===============================
   ICE Servers
================================ */
const username = "streaming";
const credential = "147d74531ecb2e76afb26a6286ce4579";

const iceServers = [
  { urls: ["turns:turn.jounetsism.biz:443?transport=tcp"], username, credential },
  { urls: ["turn:turn.jounetsism.biz:3478?transport=tcp"], username, credential },
  { urls: ["turn:turn.jounetsism.biz:3478?transport=udp"], username, credential }
];

const config = {
  iceServers,
  iceTransportPolicy: "all",
  iceCandidatePoolSize: 3
};

/* ============================================================
   SignalingClient
============================================================ */
class SignalingClient {
  constructor(url, onTrackEvent) {
    this.url = url;
    this.onTrackEvent = onTrackEvent;
    this.ws = null;
    this.heartbeatTimer = null;
    this.retry = 0;
    this.maxRetry = 20;

    this.pc = new RTCPeerConnection(config);
    this.attachPeerConnectionEvents();
  }

  attachPeerConnectionEvents() {
    this.pc.ontrack = this.onTrackEvent;

    this.pc.onicecandidate = (e) => {
      if (e.candidate) this.send({ event: "candidate", data: e.candidate });
    };

    this.pc.oniceconnectionstatechange = () => {
      console.log("[ICE]", this.pc.iceConnectionState);
    };

    this.pc.onconnectionstatechange = () => {
      console.log("[PC]", this.pc.connectionState);
    };
  }

  connect() {
    this.ws = new WebSocket(this.url);

    this.ws.onopen = () => {
      console.log("[WS] connected");
      this.retry = 0;
      this.startHeartbeat();
      this.send({ event: "offer" });
    };

    this.ws.onmessage = (ev) => {
      const msg = JSON.parse(ev.data);
      if (!msg.event) return;

      if (msg.event === "offer") {
        this.pc.setRemoteDescription(msg.data)
          .then(() => this.pc.createAnswer())
          .then(ans => {
            this.pc.setLocalDescription(ans);
            this.send({ event: "answer", data: ans });
          });

      } else if (msg.event === "candidate") {
        this.pc.addIceCandidate(new RTCIceCandidate(msg.data));
      }
    };

    this.ws.onclose = () => {
      console.warn("[WS] closed");
      this.stopHeartbeat();
      this.reconnect();
    };
  }

  reconnect() {
    if (this.retry++ >= this.maxRetry) return;
    setTimeout(() => this.connect(), 2000);
  }

  startHeartbeat() {
    this.stopHeartbeat();
    this.heartbeatTimer = setInterval(() => {
      this.send({ type: "ping" });
    }, 20000);
  }

  stopHeartbeat() {
    if (this.heartbeatTimer) clearInterval(this.heartbeatTimer);
  }

  send(data) {
    try { this.ws?.send(JSON.stringify(data)); } catch {}
  }

  close() {
    this.stopHeartbeat();
    this.ws?.close();
    this.pc.close();
  }
}

/* ============================================================
   BroadcasterClient
============================================================ */
class BroadcasterClient extends SignalingClient {
  constructor(url, localStream, onTrackEvent) {
    super(url, onTrackEvent);
    this.localStream = localStream;
  }

  connect() {
    super.connect();

    this.localStream.getTracks().forEach(track => {
      const sender = this.pc.addTrack(track, this.localStream);

      if (track.kind === "video") {
        const params = sender.getParameters();
        params.encodings = [
          { rid: "l", scaleResolutionDownBy: 3, maxBitrate: 200000, maxFramerate: 20 },
          { rid: "m", scaleResolutionDownBy: 2, maxBitrate: 500000, maxFramerate: 24 },
          { rid: "h", scaleResolutionDownBy: 1, maxBitrate: 1200000, maxFramerate: 30 },
        ];
        sender.setParameters(params).catch(console.warn);
      }
    });
  }
}

/* ============================================================
   Minimal UI Logic
============================================================ */
const localVideo = document.getElementById("local");
const remoteContainer = document.getElementById("remote-container");

function addRemoteVideo(stream) {
  const v = document.createElement("video");
  v.autoplay = true;
  v.playsInline = true;
  v.muted = true;
  v.srcObject = stream;
  remoteContainer.appendChild(v);

  // ---- ★ トラック削除時の DOM クリーンアップ ----
  stream.getTracks().forEach(track => {
    track.onended = () => v.remove();
  });
  stream.onremovetrack = () => v.remove();
}

async function start() {
  const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
  localVideo.srcObject = stream;
  localVideo.onloadedmetadata = () => localVideo.play();

  const signaling = new BroadcasterClient(
    `/ws/live/1/${Math.floor(Math.random()*10000)}`,
    stream,
    (event) => {
      if (event.track.kind === "audio") return;

      const remoteStream = event.streams[0] || new MediaStream([event.track]);
      addRemoteVideo(remoteStream);
    }
  );

  signaling.connect();
}

start();
</script>

</body>
</html>