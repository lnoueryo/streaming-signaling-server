<!DOCTYPE html>
<html>
  <!--
    SPDX-FileCopyrightText: 2023 The Pion community <https://pion.ly>
    SPDX-License-Identifier: MIT
  -->

  <head>
    <meta charset="utf-8">
  </head>
  <body>
    <h3> Remote Video </h3>
    <div id="remoteVideos"></div> <br />

    <h3> Logs </h3>
    <div id="logs"></div>


  </body>

  <script>
    let pc = new RTCPeerConnection()
    pc.ontrack = function (event) {
      if (event.track.kind === 'audio') {
        return
      }
      const stream = event.streams[0] || new MediaStream([event.track]);
      let el = document.createElement(event.track.kind)
      el.srcObject = stream
      el.autoplay = true
      el.controls = true
      document.getElementById('remoteVideos').appendChild(el)

      event.track.onmute = function(event) {
        el.play()
      }

      stream.onremovetrack = ({track}) => {
        if (el.parentNode) {
          el.parentNode.removeChild(el)
        }
      }
    }

    let ws = new WebSocket(`ws://localhost:8080/ws/live/1/${Math.floor(Math.random() * (10000 + 1))}`)
    pc.onicecandidate = e => {
      if (!e.candidate) {
        return
      }

      ws.send(JSON.stringify({type: 'candidate', data: e.candidate}))
    }

    ws.onclose = function(evt) {
      // window.alert("Websocket has closed")
    }

    ws.onmessage = function(evt) {
      let msg = JSON.parse(evt.data)
      if (!msg) {
        return console.log('failed to parse msg')
      }
      console.log(msg)
      switch (msg.type) {
        case 'offer':
          let offer = msg.data
          if (!offer) {
            return console.log('failed to parse answer')
          }
          pc.setRemoteDescription(offer)
          pc.createAnswer().then(answer => {
            pc.setLocalDescription(answer)
            ws.send(JSON.stringify({type: 'answer', data: { sdp: answer.sdp }}))
            console.log('send answer')
          })
          return

        case 'candidate':
          let candidate = msg.data
          if (!candidate) {
            return console.log('failed to parse candidate')
          }

          pc.addIceCandidate(candidate)
      }
    }

    ws.onerror = function(evt) {
      console.log("ERROR: " + evt.data)
    }
    ws.onopen = () => {
      console.log('ok')
      ws.send(JSON.stringify({type: 'viewer'}))
    }
  </script>
</html>