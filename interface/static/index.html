  <!DOCTYPE html>
  <html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>Viewer - Go WebRTC SFU</title>
  </head>
  <body style="background:#111;color:#eee;text-align:center;">
    <h2>WebRTC Viewer</h2>
    <video id="video" autoplay playsinline style="width:80%;background:black;"></video>
    <button onclick="connectWebsocket()">connect</button>
    <button onclick="closeWebsocket()">close</button>

    <script>
      let ws;
      let pc;
      const pendingCandidates = [];

      const connectWebsocket = () => {
        ws = new WebSocket(`ws://${location.host}/ws/live/1/1`);
        pc = new RTCPeerConnection();

        const video = document.getElementById("video");

        // ðŸŽ¥ ã‚¹ãƒˆãƒªãƒ¼ãƒ å—ä¿¡
        pc.ontrack = (event) => {
          console.log("ðŸ“¥ ontrack fired:", event.streams);
          if (event.streams && event.streams[0]) {
            video.srcObject = event.streams[0];
          }
        };

        // ðŸŒ ICE candidate é€ä¿¡
        pc.onicecandidate = (event) => {
          if (event.candidate) {
            const c = event.candidate.toJSON();
            ws.send(JSON.stringify({
              type: "candidate",
              data: { roomId: 1, userId: 1, ...c },
            }));
          }
        };

        // ðŸ”— æŽ¥ç¶šé–‹å§‹
        ws.onopen = () => {
          console.log("ðŸ”— WebSocket connected (viewer)");
          ws.send(JSON.stringify({ type: "join", data: { roomId: 1, userId: 1 } }));
        };

        ws.onerror = (e) => {
          console.error("âŒ WebSocket connection failed:", e)
        }
        ws.onclose = (e) => {
          console.log("ðŸ”Œ closed:", e.code, e.reason)
          pc?.close()
        }

        // ðŸ’¬ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡
        ws.onmessage = async (e) => {
          const msg = JSON.parse(e.data);
          console.log("ðŸ“¨ WS message:", msg.type, "data:", msg.data);

          // --- 1ï¸âƒ£ join å¿œç­” ---
          if (msg.type === "join") {
            ws.send(JSON.stringify({ type: "viewer", data: { roomId: 1, userId: 1 } }));
            console.log("send viewer");
          }

          // --- 2ï¸âƒ£ offer å—ä¿¡ï¼ˆã‚µãƒ¼ãƒãƒ¼â†’ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆï¼‰---
          else if (msg.type === "offer") {
            console.log("ðŸ“¥ received offer from server");

            await pc.setRemoteDescription({ type: "offer", sdp: msg.data.sdp });
            const answer = await pc.createAnswer();
            await pc.setLocalDescription(answer);

            ws.send(JSON.stringify({
              type: "answer",
              data: { sdp: answer.sdp, roomId: 1, userId: 1 },
            }));

            // offeré©ç”¨å¾Œã«ä¿ç•™ä¸­candidateã‚’é©ç”¨
            for (const c of pendingCandidates) {
              try {
                await pc.addIceCandidate(c);
                console.log("âœ… added queued candidate");
              } catch (err) {
                console.warn("âš ï¸ Failed to add queued ICE candidate:", err);
              }
            }
            pendingCandidates.length = 0; // clear
          }

          // --- 3ï¸âƒ£ candidate å—ä¿¡ ---
          else if (msg.type === "candidate") {
            const c = msg.data;
            if (!c) return;
  
            // nullå€¤ãƒã‚§ãƒƒã‚¯
            if (c.sdpMid == null && c.sdpMLineIndex == null) {
              console.log("âš ï¸ skip end-of-candidates", c);
              return;
            }
  
            // RTCIceCandidateã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ç”Ÿæˆ
            const candidate = new RTCIceCandidate({
              candidate: c.candidate,
              sdpMid: c.sdpMid,
              sdpMLineIndex: c.sdpMLineIndex,
              usernameFragment: c.usernameFragment ?? undefined,
            });
            // remoteDescriptionæœªè¨­å®šãªã‚‰ã‚­ãƒ¥ãƒ¼ã«ä¿å­˜
            if (!pc.remoteDescription) {
              console.log("ðŸ’¤ candidate queued (no remoteDescription yet)");
              pendingCandidates.push(candidate);
            } else {
              try {
                await pc.addIceCandidate(candidate);
                console.log("âœ… added ICE candidate:", candidate.candidate);
              } catch (err) {
                console.error("âŒ Failed to add ICE candidate:", err);
              }
            }
          }
        };
      };

      const closeWebsocket = () => {
        ws?.close();
      };

      connectWebsocket();
    </script>
  </body>
  </html>